/**
 * nom-install.js
 * Created by raul on 11/19/14.
 */

var RSVP = require('rsvp');
var npmi = require('npmi');
var chalk = require('chalk');
var path = require('path');

module.exports = function run(options) {

    console.log(chalk.green('Installing packages for tooling via npm.'));

    //var npmOptions = {
    //    loglevel: options.verbose ? 'verbose' : 'error',
    //    logstream: this.ui.outputStream,
    //    color: 'always',
    //    'save-dev': !!options['save-dev']
    //};

    var options = {
        //name: 'your-module',    // your module name
        //version: '0.0.1',       // expected version [default: 'latest']
        //path: '.',              // installation path [default: '.']
        //forceInstall: false,    // force install if set to true (even if already installed, it will do a reinstall) [default: false]
        npmLoad: {                // npm.load(options, callback): this is the "options" given to npm.load()
            loglevel: 'silent',   // [default: {loglevel: 'silent'}]
            color: 'always'
        }
    };

    var packages = options.packages || [];

    return new RSVP.Promise(function(resolve, reject) {

        npmi(options, function (err, result) {
            if (err) {
                if (err.code === npmi.LOAD_ERR) {
                    reject(new Error('npm load error'));
                } else if (err.code === npmi.INSTALL_ERR) {
                    reject(new Error('npm install error'));
                }
                reject(new Error(err.message));
                return;
            }
            // installed
            resolve();
        });
    })
    .finally(function() {
        //spinner stop
    })
    .then(function() {
        console.log(chalk.green('Installed packages for tooling via npm.'));
    });
}