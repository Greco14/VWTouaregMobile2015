var RSVP = require('rsvp');
var chalk = require('chalk');
var prettyTime = require('pretty-hrtime');
var tildify = require('tildify');
var gutil = require('gulp-util');

module.exports = function start(task) {
    return new RSVP.Promise(function(resolve, reject) {

        var findup = require('findup-sync');
        var path = require('path');
        var cwd = process.cwd();

        var configFile = findup('basefile.js', { cwd: cwd });
        if (configFile) {
            cwd = path.dirname(configFile);
            process.chdir(cwd);
        } else {
            reject(new Error('No `basefile` found.'));
            return;
        }

        require(configFile);

        console.log('Using basefile', chalk.magenta(tildify(configFile)));

        var gulpInst = require("gulp");
        gulpInst.on('task_start', function (e) {
            gutil.log('Starting', '\'' + chalk.cyan(e.task) + '\'...');
        });

        gulpInst.on('task_stop', function (e) {
            var time = prettyTime(e.hrDuration);
            gutil.log(
                'Finished', '\'' + chalk.cyan(e.task) + '\'',
                'after', chalk.magenta(time)
            );
        });

        process.nextTick(function () {
            gulpInst.start.apply(gulpInst, [task, function (err) {
                if (err !== null) {
                    reject(err);
                    return;
                }
                resolve();
            }]);
        });
    });
};