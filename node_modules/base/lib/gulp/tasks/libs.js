/**
 * libs.js
 * Created by raul on 11/20/14.
 */

var plugins = require('gulp-load-plugins')({
    scope: ['dependencies'],
    pattern: ['gulp-*','browser-sync', 'main-bower-files', 'vinyl-map']
});
var path = require("path");
var conf = require('../config').vendor;
var jsconf = conf.js;
var handleErrors = require('../util/handleErrors');
var cli = require('../../cli');

plugins.notify.logLevel(0);

module.exports = function (gulp) {
    var isProduction = cli.argv["production"];
    gulp.task("libs", function () {
        return gulp.src(jsconf.src)
            .pipe(plugins.plumber({errorHandler: handleErrors}))
            .pipe(plugins.vinylMap(function(chuck, filename) {
                var files = plugins.mainBowerFiles().map(function(bowerModulePath) {
                    var filePathFromVendor = path.relative(path.resolve(jsconf.sourceRoot), bowerModulePath);
                    return "'" + filePathFromVendor + "'";
                });
                var includes = "//= include [" + files.toString() +  "]";
                var chuck = includes + "\n" + chuck;
                return chuck;
            }))
            .pipe(plugins.include())
            .pipe(plugins.if(isProduction, plugins.uglify()))
            .pipe(gulp.dest(jsconf.dest))
            .pipe(plugins.browserSync.reload({stream: true, once: true}))
            .pipe(plugins.notify({message: 'Libs task complete'}));
    })
};
