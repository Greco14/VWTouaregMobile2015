/**
 * scripts.js
 * Created by raul on 11/20/14.
 */

var plugins = require('gulp-load-plugins')({scope: ['dependencies'],  pattern: ['gulp-*','browser-sync']});
var ts = require('../config').typescript;
var tsProject = plugins.typescript.createProject(ts.tsProject.settings);
var cli = require('../../cli');

plugins.notify.logLevel(0);

module.exports = function (gulp) {

    var isProduction = cli.argv["production"];

    gulp.task('scripts', ["templates"], function () {
        var tsResult = gulp.src(ts.src)
            .pipe(plugins.sourcemaps.init())
            .pipe(plugins.typescript(tsProject));
        return tsResult.js
            .pipe(plugins.concat(ts.outputName))
            .pipe(plugins.cleanTsExtends())
            .pipe(plugins.if(isProduction, plugins.uglify()))
            .pipe(plugins.sourcemaps.write('./'))
            .pipe(gulp.dest(ts.dest))
            .pipe(plugins.browserSync.reload({stream: true, once: true}))
            .pipe(plugins.notify({message: 'Scripts task complete'}));
    });
}