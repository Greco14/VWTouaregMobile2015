/**
 * styles.js
 * Created by raul on 11/20/14.
 */

var plugins = require('gulp-load-plugins')({
    scope: ['dependencies'],
    pattern: ['gulp-*','browser-sync']
});

var vendorConfig = require('../config').vendor;
var styles = require('../config').styles;
var handleErrors = require('../util/handleErrors');
var cli = require('../../cli');

plugins.notify.logLevel(0);

module.exports = function (gulp) {

    var isProduction = cli.argv["production"];

    gulp.task('styles', function () {

        var config = {
            includePaths: require('node-neat').includePaths
        };

        return gulp.src(vendorConfig.styles.src, {base: vendorConfig.sourceRoot})
            .pipe(plugins.plumber({errorHandler: handleErrors}))
            .pipe(plugins.importCss())
            .pipe(plugins.addSrc(styles.src))
            .pipe(plugins.sass(config))
            .pipe(plugins.concat(styles.outputName))
            .pipe(plugins.if(isProduction, plugins.minifyCss()))
            .pipe(gulp.dest(styles.dest))
            .pipe(plugins.browserSync.reload({stream: true}))
            .pipe(plugins.notify({message: 'Styles task complete'}));
    });
}